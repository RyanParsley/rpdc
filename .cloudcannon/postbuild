#!/bin/bash

# CloudCannon Postbuild Hook - POSSE Syndication Sync
# This hook commits POSSE syndication changes back to the repository

echo "üîÑ CloudCannon Postbuild: Processing POSSE syndication sync..."

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "‚ùå Error: Not in a git repository"
    exit 1
fi

# Check for changes in ephemera directory
EPHEMERA_DIR="src/content/ephemera"
if [ ! -d "$EPHEMERA_DIR" ]; then
    echo "‚ÑπÔ∏è  Ephemera directory not found: $EPHEMERA_DIR"
    echo "‚ú® CloudCannon Postbuild: Complete"
    exit 0
fi

# Check if there are any changes to commit
if git diff --quiet "$EPHEMERA_DIR"; then
    echo "‚ÑπÔ∏è  No changes detected in ephemera directory"
    echo "‚ú® CloudCannon Postbuild: Complete"
    exit 0
fi

echo "üìù Found changes in ephemera directory"

# Configure git (if needed)
if [ -z "$(git config user.name)" ]; then
    git config user.name "CloudCannon Build"
fi
if [ -z "$(git config user.email)" ]; then
    git config user.email "build@cloudcannon.com"
fi

# Add changes
echo "üì§ Adding changes..."
git add "$EPHEMERA_DIR"

# Check if there are staged changes
if git diff --cached --quiet; then
    echo "‚ÑπÔ∏è  No staged changes to commit"
    echo "‚ú® CloudCannon Postbuild: Complete"
    exit 0
fi

# Count syndication links added
SYNDICATION_COUNT=$(git diff --cached -U0 "$EPHEMERA_DIR" | grep "^+syndication:" | wc -l)
if [ "$SYNDICATION_COUNT" -gt 0 ]; then
    COMMIT_MESSAGE="POSSE: Update syndication links for $SYNDICATION_COUNT post(s) [skip ci]"
else
    COMMIT_MESSAGE="POSSE: Update ephemera posts [skip ci]"
fi

# Commit changes
echo "üíæ Committing changes..."
if git commit -m "$COMMIT_MESSAGE"; then
    echo "‚úÖ Successfully committed changes: $COMMIT_MESSAGE"

    # Push to remote (if remote exists)
    if git remote get-url origin > /dev/null 2>&1; then
        echo "üöÄ Pushing changes to remote..."
        if git push origin main 2>/dev/null || git push origin master 2>/dev/null; then
            echo "‚úÖ Successfully pushed changes to remote"
        else
            echo "‚ö†Ô∏è  Failed to push changes to remote (this may be normal for some setups)"
        fi
    else
        echo "‚ÑπÔ∏è  No remote repository configured"
    fi
else
    echo "‚ùå Failed to commit changes"
    exit 1
fi

echo "‚ú® CloudCannon Postbuild: Complete"
