#!/bin/bash

# CloudCannon Postbuild Hook - ACTIVE
# POSSE syndication runs automatically during Astro build via integration
# This hook commits any POSSE changes back to GitHub

# Ensure we're in the repository root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
cd "$REPO_ROOT" || exit 1

cd "$(dirname "$0")/.." || exit 1

echo "üîÑ CloudCannon Postbuild: Checking for POSSE changes..."

# Check if there are any changes in the ephemera directory
if git diff --quiet src/content/ephemera/; then
    echo "‚ÑπÔ∏è  No POSSE changes to commit"
else
    echo "üìù Committing POSSE syndication updates..."

    # Configure git (CloudCannon provides these automatically)
    git config user.name "CloudCannon Build"
    git config user.email "build@cloudcannon.com"

    # Add and commit the changes
    git add src/content/ephemera/
    git commit -m "POSSE: Update syndication links [skip ci]" --no-verify

    # Push the changes (with error handling)
    if git push origin HEAD; then
        echo "‚úÖ Successfully pushed POSSE changes to GitHub"
    else
        echo "‚ö†Ô∏è  Failed to push POSSE changes to GitHub"
        echo "   This may be due to branch protection or permissions"
        echo "   Changes are still committed locally"
    fi
fi

echo "‚ú® CloudCannon Postbuild: Complete"
