#!/bin/bash

# CloudCannon Postbuild Hook - VALIDATION & COMMIT
# POSSE syndication runs automatically during Astro build via integration
# This hook validates syndication and commits changes if SYNC_PATHS fails

echo "üîÑ CloudCannon Postbuild: Validating POSSE syndication..."

# Check if any ephemera files have syndication links (indicating successful syndication)
EPHEMERA_DIR="src/content/ephemera"
SYNDICATION_COUNT=$(grep -r "syndication:" "$EPHEMERA_DIR" 2>/dev/null | wc -l)

if [ "$SYNDICATION_COUNT" -gt 0 ]; then
	echo "‚úÖ Found $SYNDICATION_COUNT ephemera posts with syndication links"

	# Check if there are uncommitted changes
	if git diff --quiet "$EPHEMERA_DIR"; then
		echo "‚ÑπÔ∏è  No changes to commit - SYNC_PATHS may have already committed them"
	else
		echo "üìù Found uncommitted changes, attempting to commit..."

		# Configure git
		git config user.name "CloudCannon Build"
		git config user.email "build@cloudcannon.com"

		# Add and commit changes
		git add "$EPHEMERA_DIR"
		if git commit -m "POSSE: Update syndication links [skip ci]" --no-verify; then
			echo "‚úÖ Successfully committed POSSE changes"

			# Try to push (this might fail due to permissions)
			if git push origin HEAD 2>/dev/null; then
				echo "‚úÖ Successfully pushed POSSE changes to GitHub"
			else
				echo "‚ö†Ô∏è  Failed to push to GitHub (this may be due to branch protection)"
			fi
		else
			echo "‚ö†Ô∏è  No changes to commit"
		fi
	fi
else
	echo "‚ÑπÔ∏è  No syndicated posts found (this may be normal if no recent posts were processed)"
fi

echo "‚ú® CloudCannon Postbuild: Complete"
